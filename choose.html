<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ªçn t·ª´ ƒë·ªÉ h·ªçc - App t·ª´ v·ª±ng</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #000;
            color: #fff;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #fff;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .back-button {
            background-color: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }

        .back-button:hover {
            background-color: #555;
        }

        .word-list {
            margin-top: 20px;
        }

        .word-item {
            background-color: #222;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .word-item:hover {
            background-color: #2a2a2a;
        }

        .word-content {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
        }

        .word-en {
            font-weight: bold;
            color: #1a73e8;
            font-size: 1.1em;
            min-width: 120px;
        }

        .word-pronunciation {
            color: #ccc;
            font-size: 0.9em;
            min-width: 100px;
        }

        .word-meaning {
            color: #fff;
            flex: 1;
        }

        .word-level {
            color: #888;
            font-size: 0.9em;
            min-width: 50px;
            text-align: right;
        }

        .no-data {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }

        .warning-message {
            background-color: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            color: #ff6b6b;
        }

        .study-button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
            width: 100%;
        }

        .study-button:hover {
            background-color: #0d62d9;
        }

        .study-button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Ch·ªçn t·ª´ ƒë·ªÉ h·ªçc</h1>
            <a href="index.html" class="back-button">‚Üê Quay l·∫°i</a>
        </header>

        <div id="warningMessage" class="warning-message hidden">
            <!-- Th√¥ng b√°o c·∫£nh b√°o s·∫Ω hi·ªán ·ªü ƒë√¢y -->
        </div>

        <div class="word-list" id="wordList">
            <!-- Danh s√°ch t·ª´ s·∫Ω hi·ªán ·ªü ƒë√¢y -->
        </div>

        <button class="study-button" id="studyButton" disabled>Study</button>
    </div>

    <script>
        // L·∫•y danh s√°ch t·ª´ v·ª±ng
        function getVocabularies() {
            return JSON.parse(localStorage.getItem('vocabularies')) || [];
        }

        // L·∫•y danh s√°ch th∆∞ m·ª•c
        function getFolders() {
            return JSON.parse(localStorage.getItem('folders')) || [];
        }

        // Ki·ªÉm tra t·ª´ c√≥ c·∫ßn √¥n t·∫≠p kh√¥ng (D√ôNG TR∆Ø·ªúNG nt)
        function needsReview(vocab) {
            const now = Date.now();
            return now >= (vocab.nt || 0);
        }

        // L·∫•y t·ª´ v·ª±ng c·∫ßn h·ªçc
        function getWordsToLearn() {
            const allVocabularies = getVocabularies();
            
            let wordsToLearn = allVocabularies.filter(vocab => needsReview(vocab));

            // S·∫Øp x·∫øp theo ∆∞u ti√™n m·ªõi
            wordsToLearn.sort((a, b) => {
                // ∆Øu ti√™n 1: T·ª´ level 1 (t·ª´ l√†m sai reset)
                if (a.l === 1 && b.l !== 1) return -1;
                if (b.l === 1 && a.l !== 1) return 1;
                
                // ∆Øu ti√™n 2: T·ª´ qu√° h·∫°n nhi·ªÅu h∆°n
                const now = Date.now();
                const overdueA = now - (a.nt || 0);
                const overdueB = now - (b.nt || 0);
                if (overdueA !== overdueB) {
                    return overdueB - overdueA; // Qu√° h·∫°n nhi·ªÅu h∆°n x·∫øp tr∆∞·ªõc
                }
                
                // ∆Øu ti√™n 3: T·ª´ level 0 (t·ª´ m·ªõi n·∫°p)
                if (a.l === 0 && b.l !== 0) return -1;
                if (b.l === 0 && a.l !== 0) return 1;
                
                return 0;
            });

            return wordsToLearn.slice(0, 10); // L·∫•y t·ªëi ƒëa 10 t·ª´
        }

        // Ph√°t √¢m t·ª´ - CH·ªà D√ôNG WEB SPEECH API (KH√îNG D√ôNG MP3)
        function playWordPronunciation(word) {
            if ('speechSynthesis' in window) {
                // D·ª´ng ph√°t √¢m thanh c≈© n·∫øu c√≥
                speechSynthesis.cancel();
                
                // T·∫°o ph√°t √¢m m·ªõi
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-US';
                utterance.rate = 0.8; // T·ªëc ƒë·ªô ch·∫≠m l·∫°i ƒë·ªÉ d·ªÖ nghe
                
                console.log('üîä ƒêang ph√°t √¢m:', word);
                speechSynthesis.speak(utterance);
            } else {
                console.log('‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ph√°t √¢m thanh');
            }
        }

        // Hi·ªÉn th·ªã danh s√°ch t·ª´ ƒë·ªÉ h·ªçc
        function displayWordsToLearn() {
            const wordList = document.getElementById('wordList');
            const warningMessage = document.getElementById('warningMessage');
            const studyButton = document.getElementById('studyButton');

            const wordsToLearn = getWordsToLearn();

            // Ki·ªÉm tra s·ªë l∆∞·ª£ng t·ª´
            if (wordsToLearn.length < 4) {
                warningMessage.innerHTML = `Ch·ªâ c√≥ ${wordsToLearn.length} t·ª´ c·∫ßn h·ªçc. C·∫ßn n·∫°p th√™m t·ª´ m·ªõi!`;
                warningMessage.classList.remove('hidden');
                studyButton.disabled = true;
            } else {
                warningMessage.classList.add('hidden');
                studyButton.disabled = false;
            }

            // Hi·ªÉn th·ªã danh s√°ch t·ª´
            if (wordsToLearn.length === 0) {
                wordList.innerHTML = '<div class="no-data">Kh√¥ng c√≥ t·ª´ n√†o c·∫ßn h·ªçc</div>';
                return;
            }

            wordList.innerHTML = wordsToLearn.map(word => {
                return `
                    <div class="word-item" onclick="playWordPronunciation('${word.w}')">
                        <div class="word-content">
                            <div class="word-en">${word.w}</div>
                            <div class="word-pronunciation">${word.p || ''}</div>
                            <div class="word-meaning">${word.m || ''}</div>
                        </div>
                        <div class="word-level">Lv:${word.l || 0}</div>
                    </div>
                `;
            }).join('');

            // Hi·ªÉn th·ªã th√¥ng tin s·ªë t·ª´
            studyButton.textContent = `Study (${wordsToLearn.length} t·ª´)`;
        }

        // Kh·ªüi ch·∫°y
        document.addEventListener('DOMContentLoaded', function() {
            displayWordsToLearn();

            // G·∫Øn s·ª± ki·ªán n√∫t Study
            document.getElementById('studyButton').addEventListener('click', function() {
                const selectedWords = getWordsToLearn();
                
                if (selectedWords.length < 4) {
                    alert('C·∫ßn √≠t nh·∫•t 4 t·ª´ ƒë·ªÉ b·∫Øt ƒë·∫ßu h·ªçc!');
                    return;
                }
                
                // L∆∞u danh s√°ch t·ª´ ƒë√£ ch·ªçn v√†o localStorage
                localStorage.setItem('selectedStudyWords', JSON.stringify(selectedWords));
                
                // Chuy·ªÉn sang trang study
                window.location.href = 'study.html';
            });
        });

        // T·∫†O D·ªÆ LI·ªÜU TEST T·ª∞ ƒê·ªòNG N·∫æU CH∆ØA C√ì
        setTimeout(() => {
            const existingVocab = getVocabularies();
            if (existingVocab.length === 0) {
                const testData = [
                    {w: "Apple", m: "qu·∫£ t√°o", nt: 0, l: 1, p: "/Àà√¶p.…ôl/"},
                    {w: "Computer", m: "m√°y t√≠nh", nt: 0, l: 1, p: "/k…ômÀàpjuÀê.t…ôr/"},
                    {w: "Hello", m: "xin ch√†o", nt: 0, l: 1, p: "/heÀàl…ô ä/"},
                    {w: "Book", m: "s√°ch", nt: 0, l: 1, p: "/b äk/"},
                    {w: "Pen", m: "b√∫t", nt: 0, l: 1, p: "/pen/"}
                ];
                localStorage.setItem('vocabularies', JSON.stringify(testData));
                console.log('‚úÖ ƒê√£ t·∫°o d·ªØ li·ªáu test t·ª± ƒë·ªông');
                displayWordsToLearn();
            }
        }, 1000);
    </script>
</body>
</html>