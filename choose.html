<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chọn từ để học - App từ vựng</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #000;
            color: #fff;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #fff;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .back-button {
            background-color: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }

        .back-button:hover {
            background-color: #555;
        }

        .word-list {
            margin-top: 20px;
        }

        .word-item {
            background-color: #222;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .word-item:hover {
            background-color: #2a2a2a;
        }

        .word-content {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
        }

        .word-en {
            font-weight: bold;
            color: #1a73e8;
            font-size: 1.1em;
            min-width: 120px;
        }

        .word-pronunciation {
            color: #ccc;
            font-size: 0.9em;
            min-width: 100px;
        }

        .word-meaning {
            color: #fff;
            flex: 1;
        }

        .word-level {
            color: #888;
            font-size: 0.9em;
            min-width: 50px;
            text-align: right;
        }

        .no-data {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }

        .warning-message {
            background-color: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            color: #ff6b6b;
        }

        .study-button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
            width: 100%;
        }

        .study-button:hover {
            background-color: #0d62d9;
        }

        .study-button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Chọn từ để học</h1>
            <a href="index.html" class="back-button">← Quay lại</a>
        </header>

        <div id="warningMessage" class="warning-message hidden">
            <!-- Thông báo cảnh báo sẽ hiện ở đây -->
        </div>

        <div class="word-list" id="wordList">
            <!-- Danh sách từ sẽ hiện ở đây -->
        </div>

        <button class="study-button" id="studyButton" disabled>Study</button>
    </div>

    <script>
        // Khoảng thời gian ôn tập theo level (milliseconds)
        const LEVEL_INTERVALS = {
            0: 0,           // 0 ngày (học ngay)
            1: 86400000,    // 1 ngày
            2: 259200000,   // 3 ngày
            3: 604800000,   // 7 ngày
            4: 1728000000,  // 20 ngày
            5: 2592000000,  // 30 ngày (1 tháng)
            6: 7776000000,  // 90 ngày (3 tháng)
            7: 15552000000  // 180 ngày (6 tháng)
        };

        // Lấy danh sách từ vựng
        function getVocabularies() {
            return JSON.parse(localStorage.getItem('vocabularies')) || [];
        }

        // Lấy danh sách thư mục
        function getFolders() {
            return JSON.parse(localStorage.getItem('folders')) || [];
        }

        // Kiểm tra từ có cần ôn tập không
        function needsReview(vocab) {
            if (vocab.l === 0) return true; // Từ mới chưa học
            
            const now = Date.now();
            const timeSinceLastReview = now - (vocab.t || now);
            const requiredInterval = LEVEL_INTERVALS[vocab.l] || 0;
            
            return timeSinceLastReview >= requiredInterval;
        }

        // Lấy từ vựng cần học
        function getWordsToLearn() {
            const allVocabularies = getVocabularies();
            
            let wordsToLearn = allVocabularies.filter(vocab => needsReview(vocab));

            // Sắp xếp: từ mới (level 0) trước, sau đó đến từ cần ôn tập
            wordsToLearn.sort((a, b) => {
                if (a.l === 0 && b.l > 0) return -1;
                if (a.l > 0 && b.l === 0) return 1;
                return 0;
            });

            return wordsToLearn.slice(0, 10); // Lấy tối đa 10 từ
        }

        // Chuyển đổi từ để tạo URL mp3
        function convertWordForMP3(word) {
            return word.replace(/ /g, '_');
        }

        // Phát âm từ
        function playWordPronunciation(word) {
            const convertedWord = convertWordForMP3(word);
            const audioUrl = `https://remarkable-cactus-c15479.netlify.app/mp3file/${convertedWord}.mp3`;
            
            const audio = new Audio(audioUrl);
            audio.play().catch(error => {
                console.log('Lỗi phát âm:', error);
            });
        }

        // Hiển thị danh sách từ để học
        function displayWordsToLearn() {
            const wordList = document.getElementById('wordList');
            const warningMessage = document.getElementById('warningMessage');
            const studyButton = document.getElementById('studyButton');

            const wordsToLearn = getWordsToLearn();

            // Kiểm tra số lượng từ
            if (wordsToLearn.length < 4) {
                warningMessage.innerHTML = `Chỉ có ${wordsToLearn.length} từ cần học. Cần nạp thêm từ mới!`;
                warningMessage.classList.remove('hidden');
                studyButton.disabled = true;
            } else {
                warningMessage.classList.add('hidden');
                studyButton.disabled = false;
            }

            // Hiển thị danh sách từ
            if (wordsToLearn.length === 0) {
                wordList.innerHTML = '<div class="no-data">Không có từ nào cần học</div>';
                return;
            }

            wordList.innerHTML = wordsToLearn.map(word => {
                return `
                    <div class="word-item" onclick="playWordPronunciation('${word.w}')">
                        <div class="word-content">
                            <div class="word-en">${word.w}</div>
                            <div class="word-pronunciation">${word.p || ''}</div>
                            <div class="word-meaning">${word.m || ''}</div>
                        </div>
                        <div class="word-level">Lv:${word.l || 0}</div>
                    </div>
                `;
            }).join('');

            // Hiển thị thông tin số từ
            studyButton.textContent = `Study (${wordsToLearn.length} từ)`;
        }

        // Khởi chạy
        document.addEventListener('DOMContentLoaded', function() {
            displayWordsToLearn();

            // Gắn sự kiện nút Study
            document.getElementById('studyButton').addEventListener('click', function() {
                const selectedWords = getWordsToLearn();
                
                if (selectedWords.length < 4) {
                    alert('Cần ít nhất 4 từ để bắt đầu học!');
                    return;
                }
                
                // Lưu danh sách từ đã chọn vào localStorage
                localStorage.setItem('selectedStudyWords', JSON.stringify(selectedWords));
                
                // Chuyển sang trang study
                window.location.href = 'study.html';
            });
        });
    </script>
</body>
</html>