<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch·ªçn t·ª´ ƒë·ªÉ g√µ - App t·ª´ v·ª±ng</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #000;
            color: #fff;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: #fff;
            font-size: 2em;
            margin-bottom: 20px;
        }

        .back-button {
            background-color: #666;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 20px;
        }

        .back-button:hover {
            background-color: #555;
        }

        .word-list {
            margin-top: 20px;
        }

        .word-item {
            background-color: #222;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .word-item:hover {
            background-color: #2a2a2a;
        }

        .word-content {
            display: flex;
            gap: 15px;
            align-items: center;
            flex: 1;
        }

        .word-en {
            font-weight: bold;
            color: #1a73e8;
            font-size: 1.1em;
            min-width: 120px;
        }

        .word-pronunciation {
            color: #ccc;
            font-size: 0.9em;
            min-width: 100px;
        }

        .word-meaning {
            color: #fff;
            flex: 1;
        }

        .word-level {
            color: #888;
            font-size: 0.9em;
            min-width: 50px;
            text-align: right;
        }

        .no-data {
            text-align: center;
            color: #666;
            padding: 40px;
            font-style: italic;
        }

        .warning-message {
            background-color: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            color: #ff6b6b;
        }

        .study-button {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
            width: 100%;
        }

        .study-button:hover {
            background-color: #0d62d9;
        }

        .study-button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        .type-level {
            color: #4caf50;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéÆ Ch·ªçn t·ª´ ƒë·ªÉ g√µ</h1>
            <a href="index.html" class="back-button">‚Üê Quay l·∫°i</a>
        </header>

        <div id="warningMessage" class="warning-message hidden">
            <!-- Th√¥ng b√°o c·∫£nh b√°o s·∫Ω hi·ªán ·ªü ƒë√¢y -->
        </div>

        <div class="word-list" id="wordList">
            <!-- Danh s√°ch t·ª´ s·∫Ω hi·ªán ·ªü ƒë√¢y -->
        </div>

        <button class="study-button" id="studyButton" disabled>B·∫Øt ƒë·∫ßu g√µ t·ª´</button>
    </div>

    <script>
        // L·∫•y danh s√°ch t·ª´ v·ª±ng
        function getVocabularies() {
            return JSON.parse(localStorage.getItem('vocabularies')) || [];
        }

        // Ki·ªÉm tra t·ª´ c√≥ c·∫ßn √¥n t·∫≠p kh√¥ng (D√ôNG TR∆Ø·ªúNG tnt - type next time)
        function needsTypeReview(vocab) {
            const now = Date.now();
            return now >= (vocab.tnt || 0);
        }

        // L·∫•y t·ª´ v·ª±ng c·∫ßn h·ªçc cho ch·∫ø ƒë·ªô g√µ - L·ªåC T·ª™ TR√ôNG
        function getWordsToType() {
            const allVocabularies = getVocabularies();
            
            let wordsToType = allVocabularies.filter(vocab => needsTypeReview(vocab));

            // L·ªåC B·ªé T·ª™ TR√ôNG - CH·ªà GI·ªÆ L·∫†I 1 T·ª™ CHO M·ªñI T·ª™ TI·∫æNG ANH
            const uniqueWords = new Map();
            wordsToType.forEach(vocab => {
                if (!uniqueWords.has(vocab.w)) {
                    uniqueWords.set(vocab.w, vocab);
                }
            });
            wordsToType = Array.from(uniqueWords.values());

            // S·∫Øp x·∫øp theo ∆∞u ti√™n GI·ªêNG NH∆Ø choose.html
            wordsToType.sort((a, b) => {
                // ∆Øu ti√™n t·ª´ c√≥ type level > 0 tr∆∞·ªõc
                if ((a.tl || 0) > 0 && (b.tl || 0) > 0) {
                    // C√πng c√≥ type level > 0, s·∫Øp x·∫øp theo type level th·∫•p tr∆∞·ªõc
                    if ((a.tl || 0) === (b.tl || 0)) {
                        // C√πng type level, s·∫Øp x·∫øp theo th·ªùi gian h·ªçc cu·ªëi (type last time)
                        return (a.tlt || 0) - (b.tlt || 0);
                    }
                    return (a.tl || 0) - (b.tl || 0);
                }
                
                // ∆Øu ti√™n t·ª´ c√≥ type level > 0 tr∆∞·ªõc type level = 0
                if ((a.tl || 0) > 0 && (b.tl || 0) === 0) return -1;
                if ((b.tl || 0) > 0 && (a.tl || 0) === 0) return 1;
                
                // C·∫£ hai ƒë·ªÅu c√≥ type level = 0, s·∫Øp x·∫øp theo th∆∞ m·ª•c (n·∫øu c√≥)
                if (a.s !== b.s) {
                    return a.s.localeCompare(b.s);
                }
                
                return 0;
            });

            // GI·ªöI H·∫†N 7 T·ª™
            return wordsToType.slice(0, 7);
        }

        // Ph√°t √¢m t·ª´
        function playWordPronunciation(word) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                
                console.log('üîä ƒêang ph√°t √¢m:', word);
                speechSynthesis.speak(utterance);
            } else {
                console.log('‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ph√°t √¢m thanh');
            }
        }

        // Hi·ªÉn th·ªã danh s√°ch t·ª´ ƒë·ªÉ g√µ
        function displayWordsToType() {
            const wordList = document.getElementById('wordList');
            const warningMessage = document.getElementById('warningMessage');
            const studyButton = document.getElementById('studyButton');

            const wordsToType = getWordsToType();

            // KH√îNG Y√äU C·∫¶U T·ªêI THI·ªÇU 4 T·ª™ N·ªÆA - 1 T·ª™ C≈®NG H·ªåC ƒê∆Ø·ª¢C
            if (wordsToType.length === 0) {
                warningMessage.innerHTML = 'Kh√¥ng c√≥ t·ª´ n√†o ƒë·ªÉ g√µ. C·∫ßn n·∫°p th√™m t·ª´ m·ªõi!';
                warningMessage.classList.remove('hidden');
                studyButton.disabled = true;
            } else {
                warningMessage.classList.add('hidden');
                studyButton.disabled = false;
            }

            // Hi·ªÉn th·ªã danh s√°ch t·ª´
            if (wordsToType.length === 0) {
                wordList.innerHTML = '<div class="no-data">Kh√¥ng c√≥ t·ª´ n√†o ƒë·ªÉ g√µ</div>';
                return;
            }

            wordList.innerHTML = wordsToType.map(word => {
                const typeLevel = word.tl || 0;
                return `
                    <div class="word-item" onclick="playWordPronunciation('${word.w}')">
                        <div class="word-content">
                            <div class="word-en">${word.w}</div>
                            <div class="word-pronunciation">${word.p || ''}</div>
                            <div class="word-meaning">${word.m || ''}</div>
                        </div>
                        <div class="word-level">
                            <span class="type-level">T-Lv:${typeLevel}</span>
                        </div>
                    </div>
                `;
            }).join('');

            // Hi·ªÉn th·ªã th√¥ng tin s·ªë t·ª´
            studyButton.textContent = `B·∫Øt ƒë·∫ßu g√µ t·ª´ (${wordsToType.length} t·ª´)`;
        }

        // Kh·ªüi ch·∫°y
        document.addEventListener('DOMContentLoaded', function() {
            displayWordsToType();

            // G·∫Øn s·ª± ki·ªán n√∫t Study - B·ªé KI·ªÇM TRA S·ªê L∆Ø·ª¢NG T·ªêI THI·ªÇU
            document.getElementById('studyButton').addEventListener('click', function() {
                const selectedWords = getWordsToType();
                
                // KH√îNG KI·ªÇM TRA S·ªê L∆Ø·ª¢NG T·ªêI THI·ªÇU - 1 T·ª™ C≈®NG H·ªåC ƒê∆Ø·ª¢C
                if (selectedWords.length === 0) {
                    alert('Kh√¥ng c√≥ t·ª´ n√†o ƒë·ªÉ g√µ!');
                    return;
                }
                
                // L∆∞u danh s√°ch t·ª´ ƒë√£ ch·ªçn v√†o localStorage
                localStorage.setItem('selectedTypeWords', JSON.stringify(selectedWords));
                
                // Chuy·ªÉn sang trang typwor.html
                window.location.href = 'typwor.html';
            });
        });

        // T·∫†O D·ªÆ LI·ªÜU TEST T·ª∞ ƒê·ªòNG N·∫æU CH∆ØA C√ì (v·ªõi c√°c tr∆∞·ªùng type)
        setTimeout(() => {
            const existingVocab = getVocabularies();
            if (existingVocab.length === 0) {
                const testData = [
                    {w: "Apple", m: "qu·∫£ t√°o", p: "/Àà√¶p.…ôl/", tl: 1, tlt: Date.now() - 86400000, tnt: Date.now()},
                    {w: "Computer", m: "m√°y t√≠nh", p: "/k…ômÀàpjuÀê.t…ôr/", tl: 1, tlt: Date.now() - 172800000, tnt: Date.now()},
                    {w: "Hello", m: "xin ch√†o", p: "/heÀàl…ô ä/", tl: 0, tlt: 0, tnt: 0},
                    {w: "Book", m: "s√°ch", p: "/b äk/", tl: 2, tlt: Date.now() - 259200000, tnt: Date.now()},
                    {w: "Pen", m: "b√∫t", p: "/pen/", tl: 1, tlt: Date.now() - 86400000, tnt: Date.now()},
                    {w: "Phone", m: "ƒëi·ªán tho·∫°i", p: "/f…ô än/", tl: 0, tlt: 0, tnt: 0},
                    {w: "Table", m: "c√°i b√†n", p: "/Ààte…™.b…ôl/", tl: 1, tlt: Date.now() - 432000000, tnt: Date.now()},
                    {w: "Chair", m: "c√°i gh·∫ø", p: "/t Ée…ôr/", tl: 0, tlt: 0, tnt: 0}
                ];
                localStorage.setItem('vocabularies', JSON.stringify(testData));
                console.log('‚úÖ ƒê√£ t·∫°o d·ªØ li·ªáu test t·ª± ƒë·ªông cho ch·∫ø ƒë·ªô g√µ');
                displayWordsToType();
            }
        }, 1000);
    </script>
</body>
</html>
